<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Đánh giá khách hàng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="container mt-4">
        <h2>Đánh giá khách hàng</h2>
        
        <!-- Danh sách khách hàng -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Danh sách khách hàng</h5>
                    </div>
                    <div class="card-body">
                        <div class="list-group" id="clientList">
                            <!-- Danh sách khách hàng sẽ được thêm vào đây bằng JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Thống kê khách hàng -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Thống kê tiến độ</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <canvas id="motivationChart"></canvas>
                            </div>
                            <div class="col-md-6">
                                <canvas id="adherenceChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Form đánh giá -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Thêm đánh giá mới</h5>
            </div>
            <div class="card-body">
                <form id="assessmentForm">
                    <input type="hidden" id="clientId">
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Tình trạng sức khỏe tổng quát</label>
                            <select class="form-select" id="overallHealth" required>
                                <option value="">Chọn tình trạng</option>
                                <option value="Tốt">Tốt</option>
                                <option value="Khá">Khá</option>
                                <option value="Trung bình">Trung bình</option>
                                <option value="Yếu">Yếu</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Mức độ thể lực</label>
                            <select class="form-select" id="fitnessLevel" required>
                                <option value="">Chọn mức độ</option>
                                <option value="Cao">Cao</option>
                                <option value="Trung bình">Trung bình</option>
                                <option value="Thấp">Thấp</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Mức độ động lực (1-10)</label>
                            <input type="number" class="form-control" id="motivationLevel" min="1" max="10" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Mức độ tuân thủ (1-10)</label>
                            <input type="number" class="form-control" id="adherenceLevel" min="1" max="10" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Tiến độ</label>
                        <textarea class="form-control" id="progress" rows="2" required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Đề xuất điều chỉnh</label>
                        <textarea class="form-control" id="recommendations" rows="2" required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Kế hoạch tập luyện</label>
                        <textarea class="form-control" id="exercisePlan" rows="3" required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Lời khuyên về dinh dưỡng</label>
                        <textarea class="form-control" id="nutritionAdvice" rows="2"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Mục tiêu tiếp theo</label>
                        <textarea class="form-control" id="nextGoals" rows="2" required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Ghi chú thêm</label>
                        <textarea class="form-control" id="notes" rows="2"></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Lưu đánh giá</button>
                </form>
            </div>
        </div>
        
        <!-- Lịch sử đánh giá -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Lịch sử đánh giá</h5>
            </div>
            <div class="card-body">
                <div id="assessmentList" class="list-group">
                    <!-- Danh sách đánh giá sẽ được thêm vào đây bằng JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        let motivationChart, adherenceChart;
        let selectedClientId = null;
        
        // Load danh sách khách hàng
        function loadClients() {
            fetch('/trainer/assessment/clients')
                .then(response => response.json())
                .then(clients => {
                    const clientList = document.getElementById('clientList');
                    clientList.innerHTML = '';
                    
                    clients.forEach(client => {
                        const clientHtml = `
                            <a href="#" class="list-group-item list-group-item-action" 
                               onclick="selectClient(${client.clientId})">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">Khách hàng #${client.clientId}</h6>
                                    <small>${new Date(client.assessmentDate).toLocaleDateString('vi-VN')}</small>
                                </div>
                                <p class="mb-1">${client.overallHealth}</p>
                            </a>
                        `;
                        clientList.innerHTML += clientHtml;
                    });
                })
                .catch(error => console.error('Error loading clients:', error));
        }
        
        // Chọn khách hàng
        function selectClient(clientId) {
            selectedClientId = clientId;
            document.getElementById('clientId').value = clientId;
            loadClientAssessments(clientId);
            loadClientStats(clientId);
        }
        
        // Load đánh giá của khách hàng
        function loadClientAssessments(clientId) {
            fetch(`/trainer/assessment/client/${clientId}`)
                .then(response => response.json())
                .then(assessments => {
                    const assessmentList = document.getElementById('assessmentList');
                    assessmentList.innerHTML = '';
                    
                    assessments.forEach(assessment => {
                        const date = new Date(assessment.assessmentDate).toLocaleDateString('vi-VN');
                        const assessmentHtml = `
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">Đánh giá ngày ${date}</h6>
                                    <div>
                                        <button class="btn btn-sm btn-outline-primary" 
                                                onclick="editAssessment(${assessment.id})">
                                            <i class="fas fa-edit"></i> Sửa
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" 
                                                onclick="deleteAssessment(${assessment.id})">
                                            <i class="fas fa-trash"></i> Xóa
                                        </button>
                                    </div>
                                </div>
                                <p class="mb-1">
                                    <strong>Tình trạng:</strong> ${assessment.overallHealth}<br>
                                    <strong>Thể lực:</strong> ${assessment.fitnessLevel}<br>
                                    <strong>Động lực:</strong> ${assessment.motivationLevel}/10<br>
                                    <strong>Tuân thủ:</strong> ${assessment.adherenceLevel}/10
                                </p>
                                <div class="mt-2">
                                    <strong>Tiến độ:</strong><br>
                                    ${assessment.progress}<br><br>
                                    <strong>Đề xuất:</strong><br>
                                    ${assessment.recommendations}
                                </div>
                            </div>
                        `;
                        assessmentList.innerHTML += assessmentHtml;
                    });
                })
                .catch(error => console.error('Error loading assessments:', error));
        }
        
        // Load thống kê khách hàng
        function loadClientStats(clientId) {
            fetch(`/trainer/assessment/stats/${clientId}`)
                .then(response => response.json())
                .then(stats => {
                    updateCharts(stats);
                })
                .catch(error => console.error('Error loading stats:', error));
        }
        
        // Cập nhật biểu đồ
        function updateCharts(stats) {
            if (motivationChart) motivationChart.destroy();
            if (adherenceChart) adherenceChart.destroy();
            
            // Biểu đồ động lực
            motivationChart = new Chart(
                document.getElementById('motivationChart'),
                {
                    type: 'line',
                    data: {
                        labels: ['Động lực'],
                        datasets: [{
                            label: 'Mức độ động lực',
                            data: [stats.avgMotivation],
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 10
                            }
                        }
                    }
                }
            );
            
            // Biểu đồ tuân thủ
            adherenceChart = new Chart(
                document.getElementById('adherenceChart'),
                {
                    type: 'line',
                    data: {
                        labels: ['Tuân thủ'],
                        datasets: [{
                            label: 'Mức độ tuân thủ',
                            data: [stats.avgAdherence],
                            borderColor: 'rgb(255, 99, 132)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 10
                            }
                        }
                    }
                }
            );
        }
        
        // Xử lý form submit
        document.getElementById('assessmentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!selectedClientId) {
                alert('Vui lòng chọn khách hàng');
                return;
            }
            
            const assessment = {
                clientId: selectedClientId,
                overallHealth: document.getElementById('overallHealth').value,
                fitnessLevel: document.getElementById('fitnessLevel').value,
                motivationLevel: parseInt(document.getElementById('motivationLevel').value),
                adherenceLevel: parseInt(document.getElementById('adherenceLevel').value),
                progress: document.getElementById('progress').value,
                recommendations: document.getElementById('recommendations').value,
                exercisePlan: document.getElementById('exercisePlan').value,
                nutritionAdvice: document.getElementById('nutritionAdvice').value,
                nextGoals: document.getElementById('nextGoals').value,
                notes: document.getElementById('notes').value
            };
            
            fetch('/trainer/assessment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(assessment)
            })
            .then(response => response.json())
            .then(savedAssessment => {
                alert('Đã lưu đánh giá thành công!');
                this.reset();
                loadClientAssessments(selectedClientId);
                loadClientStats(selectedClientId);
            })
            .catch(error => {
                console.error('Error saving assessment:', error);
                alert('Có lỗi xảy ra khi lưu đánh giá');
            });
        });
        
        // Xóa đánh giá
        function deleteAssessment(id) {
            if (confirm('Bạn có chắc muốn xóa đánh giá này?')) {
                fetch(`/trainer/assessment/${id}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (response.ok) {
                        alert('Đã xóa đánh giá thành công!');
                        loadClientAssessments(selectedClientId);
                        loadClientStats(selectedClientId);
                    } else {
                        throw new Error('Không thể xóa đánh giá');
                    }
                })
                .catch(error => {
                    console.error('Error deleting assessment:', error);
                    alert('Có lỗi xảy ra khi xóa đánh giá');
                });
            }
        }
        
        // Load danh sách khách hàng khi trang được tải
        document.addEventListener('DOMContentLoaded', loadClients);
    </script>
</body>
</html> 